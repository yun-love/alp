name: Deploy WebVM
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1. å®‰è£…æ„å»º ext2 æ–‡ä»¶ç³»ç»Ÿçš„å·¥å…·
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y genext2fs

      # 2. æ„å»º Docker å¹¶è½¬æ¢ä¸º EXT2 é•œåƒ
      - name: Build and Convert to Ext2
        run: |
          mkdir -p dist
          mkdir -p rootfs_temp

          # 2.1 æ„å»º Docker é•œåƒ
          # æ³¨æ„ï¼šä½ çš„ Dockerfile å†…å®¹è¶Šå¤šï¼Œè¿™é‡Œç”Ÿæˆçš„é•œåƒå°±è¶Šå¤§
          docker buildx build --platform linux/386 -t webvm-image --load .
          
          # 2.2 å¯¼å‡ºæ–‡ä»¶ç³»ç»Ÿ
          echo "æ­£åœ¨å¯¼å‡º Docker æ–‡ä»¶ç³»ç»Ÿ..."
          docker create --name temp-container webvm-image
          docker export temp-container | tar -x -C rootfs_temp
          docker rm temp-container
          
          # 2.3 è¡¥å…¨ç©ºç›®å½•
          mkdir -p rootfs_temp/proc
          mkdir -p rootfs_temp/dev
          mkdir -p rootfs_temp/tmp
          mkdir -p rootfs_temp/home/user
          chmod 777 rootfs_temp/tmp

          # 2.4 ã€æ–°å¢ã€‘æ¸…ç†åƒåœ¾ä»¥å‡å°ä½“ç§¯
          echo "æ­£åœ¨æ¸…ç†ç¼“å­˜..."
          rm -rf rootfs_temp/var/cache/apk/* 2>/dev/null || true
          rm -rf rootfs_temp/var/lib/apt/lists/* 2>/dev/null || true
          rm -rf rootfs_temp/root/.cache 2>/dev/null || true

          # 2.5 ç”Ÿæˆ ext2 ç£ç›˜é•œåƒ
          # ä¿®æ”¹æ ¸å¿ƒï¼š-b 1572864 = 1.5GB ç©ºé—´
          # ä½ çš„ç³»ç»Ÿçº¦ 900MBï¼Œéœ€è¦é¢„ç•™ç©ºé—´ï¼Œå¦åˆ™ä¼šæŠ¥é”™ "couldn't allocate a block"
          echo "æ­£åœ¨ç”Ÿæˆ ext2 é•œåƒ (é¢„è®¾ 1.5GB)..."
          genext2fs -b 1572864 -N 100000 -d rootfs_temp dist/image.ext2
          
          # 2.6 æ¸…ç†ä¸´æ—¶ç›®å½•å¹¶æ£€æŸ¥å¤§å°
          rm -rf rootfs_temp
          ls -lh dist/image.ext2

      # 3. ä¸‹è½½ COI Service Worker (è§£å†³æµè§ˆå™¨ SharedArrayBuffer é™åˆ¶)
      - name: Download Helpers
        run: |
          wget https://raw.githubusercontent.com/gzuidhof/coi-serviceworker/master/coi-serviceworker.js -O dist/coi-serviceworker.js

      # 4. ç”Ÿæˆå‰ç«¯é¡µé¢ (index.html)
      - name: Create Frontend
        run: |
          cat <<EOF > dist/index.html
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>WebVM | Linux Environment</title>
              
              <!-- 1. è·¨åŸŸéš”ç¦»è¡¥ä¸ (å¿…é¡»åœ¨æœ€å‰) -->
              <script src="coi-serviceworker.js"></script>

              <!-- 2. æ ·å¼ -->
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
              <style>
                  body { margin: 0; background: #000; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: monospace; }
                  #terminal { flex: 1; width: 100%; }
                  #overlay { 
                      position: absolute; inset: 0; background: #0d1117; z-index: 999; 
                      display: flex; flex-direction: column; align-items: center; justify-content: center; color: #c9d1d9;
                  }
                  .progress-container { width: 300px; background: #30363d; height: 6px; border-radius: 3px; margin: 20px 0; overflow: hidden; }
                  .progress-bar { height: 100%; background: #238636; width: 0%; transition: width 0.2s; }
                  #status-text { font-size: 14px; color: #8b949e; margin-bottom: 5px; }
                  .hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
              </style>
          </head>
          <body>
              <div id="overlay">
                  <h2>ğŸš€ WebVM æ­£åœ¨å¯åŠ¨</h2>
                  <div id="status-text">å‡†å¤‡ä¸‹è½½ç³»ç»Ÿé•œåƒ...</div>
                  <div class="progress-container"><div class="progress-bar" id="p-bar"></div></div>
                  <div style="font-size: 12px; color: #484f58">é•œåƒè¾ƒå¤§ (~1GB)ï¼Œé¦–æ¬¡åŠ è½½è¯·è€å¿ƒç­‰å¾…</div>
              </div>
              
              <div id="terminal"></div>

              <!-- 3. ä¾èµ–åº“ -->
              <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
              <script src="https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/index.js"></script>

              <!-- 4. æ ¸å¿ƒé€»è¾‘ -->
              <script type="module">
                  import CheerpX from 'https://webvm.io/cheerpx.js';

                  const statusEl = document.getElementById('status-text');
                  const barEl = document.getElementById('p-bar');
                  const overlay = document.getElementById('overlay');

                  async function startSystem() {
                      try {
                          // åˆå§‹åŒ– Xterm
                          const term = new Terminal({ 
                              theme: { background: '#0d1117', foreground: '#c9d1d9' }, 
                              convertEol: true, cursorBlink: true 
                          });
                          const fitAddon = { fit: () => { term.resize(Math.floor(window.innerWidth / 9), Math.floor(window.innerHeight / 17)); } };
                          term.open(document.getElementById('terminal'));
                          fitAddon.fit();
                          window.addEventListener('resize', () => fitAddon.fit());
                          
                          term.write('WebVM Bootloader v1.0\r\n');

                          // ä¸‹è½½å¤§æ–‡ä»¶ image.ext2
                          statusEl.innerText = "æ­£åœ¨ä¸‹è½½ç³»ç»Ÿç£ç›˜ (image.ext2)...";
                          
                          const response = await fetch('image.ext2');
                          if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥: " + response.statusText);
                          
                          const contentLength = response.headers.get('content-length');
                          const total = parseInt(contentLength, 10);
                          let loaded = 0;
                          
                          const reader = response.body.getReader();
                          const chunks = [];
                          
                          while(true) {
                              const {done, value} = await reader.read();
                              if (done) break;
                              chunks.push(value);
                              loaded += value.length;
                              if(total) {
                                  const pct = Math.round((loaded / total) * 100);
                                  barEl.style.width = pct + "%";
                                  statusEl.innerText = \`ä¸‹è½½ä¸­... \${pct}% (\${(loaded/1024/1024).toFixed(0)}MB / \${(total/1024/1024).toFixed(0)}MB)\`;
                              }
                          }

                          statusEl.innerText = "æ­£åœ¨è§£å‹å¹¶æŒ‚è½½å†…å­˜...";
                          // åˆå¹¶æ•°æ®å—
                          const blob = new Blob(chunks);
                          const buffer = await blob.arrayBuffer();

                          // å¯åŠ¨ CheerpX
                          statusEl.innerText = "å¯åŠ¨ Linux å†…æ ¸...";
                          const cx = await CheerpX.Linux.create({
                              mounts: [
                                  { type: "cheerpOS", mountPoint: "/proc" },
                                  { type: "cheerpOS", mountPoint: "/dev" },
                                  { type: "ext2", mountPoint: "/", buffer: buffer }
                              ]
                          });

                          // è¿æ¥æ§åˆ¶å°
                          cx.setConsole(term.write.bind(term));
                          
                          // éšè—é®ç½©
                          overlay.classList.add('hidden');
                          term.focus();

                          // è¿è¡Œ Shell
                          // å°è¯•è¿è¡Œ bashï¼Œå¦‚æœé•œåƒé‡Œæ²¡æœ‰ bash åˆ™å›é€€åˆ° sh
                          await cx.run("/bin/sh", ["-l"], {
                              env: {
                                  HOME: "/root",
                                  TERM: "xterm",
                                  PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
                              }
                          });
                          
                          term.write('\r\n\x1b[31mSystem Halted.\x1b[m\r\n');

                      } catch (e) {
                          console.error(e);
                          statusEl.innerText = "å¯åŠ¨å¤±è´¥: " + e.message;
                          statusEl.style.color = "#ff7b72";
                          alert("é”™è¯¯: " + e.message);
                      }
                  }
                  
                  startSystem();
              </script>
          </body>
          </html>
          EOF

      # 5. éƒ¨ç½²åˆ° GitHub Pages
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4