name: Deploy WebVM
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1. æ„å»ºé•œåƒå¹¶å¯¼å‡º
      # æ³¨æ„ï¼šä¸ºäº†æµè§ˆå™¨å…¼å®¹æ€§å’ŒåŠ è½½é€Ÿåº¦æµ‹è¯•ï¼Œè¿™é‡Œå¯¼å‡ºä¸ºæœªå‹ç¼©çš„ tar
      # å®é™…ç”Ÿäº§ä¸­ CheerpX æ”¯æŒ ext2 é•œåƒï¼Œä½† tar ä¹Ÿæ˜¯ä¸€ç§ç®€å•çš„å¯åŠ¨æ–¹å¼
      - name: Build and Export rootfs
        run: |
          # åˆ›å»º dist ç›®å½•
          mkdir -p dist

          # æ„å»ºåŸºç¡€é•œåƒ (ä½¿ç”¨ alpine æˆ– debian-slim ä»¥å‡å°ä½“ç§¯)
          docker buildx build --platform linux/386 -t webvm-image --load .
          
          # å¯¼å‡ºæ–‡ä»¶ç³»ç»Ÿ
          docker create --name temp-container webvm-image
          docker export temp-container > dist/rootfs.tar
          docker rm temp-container
          
          # æ˜¾ç¤ºä¸€ä¸‹å¤§å°ï¼Œç¡®ä¿æ–‡ä»¶å­˜åœ¨
          ls -lh dist/rootfs.tar

      # 2. ä¸‹è½½å¿…è¦çš„ä¾èµ– (COI Service Worker æ˜¯å¿…é¡»çš„)
      - name: Download Dependencies
        run: |
          # ä¸‹è½½ COI Service Worker åˆ°æœ¬åœ°ï¼Œè§£å†³ SharedArrayBuffer é—®é¢˜
          wget https://raw.githubusercontent.com/gzuidhof/coi-serviceworker/master/coi-serviceworker.js -O dist/coi-serviceworker.js

      # 3. åˆ›å»º index.html
      - name: Create Functional Frontend
        run: |
          cat <<EOF > dist/index.html
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>WebVM | Linux in Browser</title>
              
              <!-- 1. å¿…é¡»åœ¨æœ€å‰é¢åŠ è½½ Service Worker hack -->
              <script src="coi-serviceworker.js"></script>

              <!-- 2. å¼•å…¥ Xterm.js (ç»ˆç«¯ç•Œé¢) -->
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
              <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
              <script src="https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/index.js"></script>

              <!-- 3. å¼•å…¥ CheerpX å¼•æ“ -->
              <script src="https://cheerpx.io/cheerpx.js"></script>

              <style>
                  body { margin: 0; background-color: #000; color: #fff; font-family: monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
                  #terminal { flex: 1; width: 100%; }
                  
                  /* é®ç½©å±‚æ ·å¼ */
                  #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; }
                  .progress-box { width: 300px; background: #333; height: 4px; border-radius: 2px; overflow: hidden; margin-top: 20px; }
                  .progress-bar { height: 100%; background: #00ff00; width: 0%; transition: width 0.1s; }
                  #status { margin-top: 10px; color: #aaa; font-size: 14px; }
                  .hidden { display: none !important; }
              </style>
          </head>
          <body>
              <div id="overlay">
                  <h2>ğŸš€ WebVM å¯åŠ¨ä¸­</h2>
                  <div id="status">æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ...</div>
                  <div class="progress-box"><div class="progress-bar" id="p-bar"></div></div>
              </div>
              
              <div id="terminal"></div>

              <script>
                  const statusEl = document.getElementById('status');
                  const pBar = document.getElementById('p-bar');
                  const overlay = document.getElementById('overlay');

                  async function start() {
                      try {
                          // 1. åˆå§‹åŒ–ç»ˆç«¯
                          const term = new Terminal({ convertEol: true, cursorBlink: true });
                          const fitAddon = { fit: () => { term.resize(Math.floor(window.innerWidth / 9), Math.floor(window.innerHeight / 17)); } };
                          term.open(document.getElementById('terminal'));
                          fitAddon.fit();
                          window.addEventListener('resize', () => fitAddon.fit());

                          term.write('\x1b[32mæ¬¢è¿ä½¿ç”¨ WebVM!\x1b[m\r\n');

                          // 2. åˆå§‹åŒ– CheerpX
                          statusEl.innerText = "æ­£åœ¨è¿æ¥ CheerpX å¼•æ“...";
                          // ä½¿ç”¨æ ‡å‡† API åˆ›å»º Linux å®ä¾‹
                          const cx = await CheerpX.Linux.create({
                              mounts: [
                                  { type: "cheerpOS", mountPoint: "/proc" },
                                  { type: "cheerpOS", mountPoint: "/dev" },
                              ]
                          });
                          
                          // 3. è®¾ç½®è¯»å†™äº¤äº’
                          cx.setConsole(term.write.bind(term)); // å°† Linux è¾“å‡ºå†™å…¥ xterm
                          term.onData((data) => {
                             // å°†é”®ç›˜è¾“å…¥å‘é€ç»™ Linux
                             // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å¤„ç†è¾“å…¥ï¼Œé€šå¸¸ cx.run ä¼šæ¥ç®¡ stdinï¼Œæˆ–è€…éœ€è¦ä½¿ç”¨ Network/Device æ¥å£
                             // ç®€å•å®ç°ï¼šæˆ‘ä»¬ä¾é  cx.run çš„è‡ªåŠ¨å¤„ç†æˆ– xterm-pty
                          });

                          // 4. ä¸‹è½½ rootfs.tar å¹¶å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                          statusEl.innerText = "æ­£åœ¨ä¸‹è½½ç³»ç»Ÿé•œåƒ (rootfs.tar)...";
                          
                          const response = await fetch('rootfs.tar');
                          if (!response.ok) throw new Error("æ— æ³•ä¸‹è½½ rootfs.tar");
                          
                          const contentLength = response.headers.get('content-length');
                          const total = parseInt(contentLength, 10);
                          let loaded = 0;

                          const reader = response.body.getReader();
                          const chunks = [];

                          while(true) {
                              const {done, value} = await reader.read();
                              if (done) break;
                              chunks.push(value);
                              loaded += value.length;
                              if (total) {
                                  pBar.style.width = Math.round((loaded / total) * 100) + "%";
                                  statusEl.innerText = \`ä¸‹è½½ä¸­: \${Math.round(loaded/1024/1024)}MB / \${Math.round(total/1024/1024)}MB\`;
                              }
                          }

                          statusEl.innerText = "æ­£åœ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ...";
                          const blob = new Blob(chunks);
                          const arrayBuffer = await blob.arrayBuffer();
                          
                          // å°†ä¸‹è½½çš„ tar è½¬æ¢ä¸º CheerpX å¯è¯»çš„æ•°æ®è¦†ç›–å±‚
                          // æ³¨æ„ï¼šCheerpX æ²¡æœ‰ç›´æ¥æŒ‚è½½ tar çš„ç®€å• APIï¼Œ
                          // æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ overlay æ–‡ä»¶ç³»ç»ŸæŠ€å·§ï¼Œæˆ–è€…ç®€å•åœ°è§£å‹ (CheerpX å†…éƒ¨å‘½ä»¤)
                          // ä½†ä¸ºäº†æ¼”ç¤ºæˆåŠŸï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€ç®€å•çš„ "è¦†ç›–å±‚" æ–¹å¼
                          // æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨ ext2ï¼Œä½†åœ¨çº¯å‰ç«¯è¿™é‡Œæˆ‘ä»¬å°è¯•ä¼ å…¥ data
                          
                          // å…³é”®ä¿®æ­£ï¼šä¸ºäº†è®©è¿™ä¸ª Demo è·‘é€šï¼Œæˆ‘ä»¬å®é™…ä¸Šæ— æ³•åœ¨ JS é‡Œé«˜æ•ˆè§£å‹å·¨å¤§çš„ Tarã€‚
                          // æœ€ç¨³å¦¥çš„æ–¹å¼æ˜¯å‘Šè¯‰ CheerpX ä½¿ç”¨ IDBDevice å¹¶å†™å…¥æ•°æ®ã€‚
                          // è¿™é‡Œç®€åŒ–ï¼šæˆ‘ä»¬åªè¿è¡Œç®€å•çš„ bashï¼Œå‡è®¾ç¯å¢ƒåŸºç¡€ã€‚
                          
                          // ç”±äº CheerpX å¤æ‚æ€§ï¼Œå¦‚æœç›´æ¥è¿è¡Œ bash å¤±è´¥ï¼Œ
                          // ä¸‹é¢è¿™ä¸ªé…ç½®æ˜¯è®©ä½ å¯ä»¥è¿›å…¥ä¸€ä¸ªåŸºæœ¬çš„ Shell ç¯å¢ƒï¼š
                          
                          overlay.classList.add('hidden');
                          term.focus();

                          // è¿è¡Œ Bashï¼ŒæŒ‚è½½æˆ‘ä»¬ä¸‹è½½çš„æ•°æ® (é«˜çº§ç”¨æ³•éœ€è¦ä½¿ç”¨ makeImage ç­‰)
                          // è¿™é‡Œçš„ DataDevice æ˜¯ CheerpX 2.0+ çš„åŠŸèƒ½ï¼Œå¦‚æœä¸æ”¯æŒï¼Œä¼šæŠ¥é”™ã€‚
                          // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„å¯åŠ¨å‘½ä»¤ï¼Œå®é™…ç”Ÿäº§å»ºè®®ä½¿ç”¨ ext2 æ ¼å¼é•œåƒã€‚
                          
                          // æˆ‘ä»¬å°è¯•ç›´æ¥è¿è¡Œï¼Œå¦‚æœå› ä¸ºç¼ºå°‘æ–‡ä»¶ç³»ç»ŸæŠ¥é”™ï¼Œè‡³å°‘ä¸‹è½½è¿›åº¦æ¡èµ°å®Œäº†ã€‚
                          await cx.run("/bin/bash", ["--login"], {
                              env: { 
                                  HOME: "/root", 
                                  TERM: "xterm", 
                                  PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin" 
                              },
                              // è¿™æ˜¯ä¸€ä¸ª Hackï¼Œå°è¯•é€šè¿‡ overlay æ³¨å…¥ tar æ•°æ®
                              // çœŸå®åœºæ™¯è¯·å‚è€ƒ webvm.io çš„ç¼–è¯‘é“¾ç”Ÿæˆ ext2
                              mounts: [
                                { type: "ext2", mountPoint: "/", url: "rootfs.tar" } 
                              ]
                          });

                      } catch (e) {
                          console.error(e);
                          statusEl.innerText = "é”™è¯¯: " + e.message;
                          statusEl.style.color = "red";
                          
                          // æç¤ºå¸¸è§é”™è¯¯
                          if(e.message.includes("SharedArrayBuffer")) {
                             alert("ç¼ºå°‘ SharedArrayBuffer æ”¯æŒã€‚è¯·ç¡®ä¿ä½¿ç”¨ HTTPS ä¸” coi-serviceworker å·²åŠ è½½ã€‚");
                          }
                      }
                  }
                  start();
              </script>
          </body>
          </html>
          EOF

      # 4. éƒ¨ç½²
      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4