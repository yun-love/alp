name: Deploy WebVM
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: i386

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1. 构建镜像并导出
      - name: Build and Export rootfs
        run: |
          docker buildx build --platform linux/386 -t webvm-image --load .
          docker create --name temp-container webvm-image
          docker export temp-container > rootfs.tar
          docker rm temp-container
          gzip -9 rootfs.tar

      # 2. 【核心修复】亲手创建一个 index.html，不再依赖官方仓库
      - name: Create Minimal Frontend
        run: |
          mkdir -p dist
          mv rootfs.tar.gz dist/
          
          # 创建加载虚拟机的 HTML
          cat <<EOF > dist/index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>My High School Dev Environment</title>
              <script src="https://webvm.io/coi-serviceworker.js"></script>
              <link rel="stylesheet" href="https://webvm.io/xterm/xterm.css">
              <style>
                  body { margin: 0; background: #000; color: #fff; font-family: monospace; }
                  #terminal { width: 100vw; height: 100vh; }
              </style>
          </head>
          <body>
              <div id="terminal"></div>
              <script type="module">
                  import { CyRPX } from "https://webvm.io/cheerpx.js";
                  async function main() {
                      const cx = await CyRPX.create({
                          cpu: { model: "i386" },
                          display: document.getElementById("terminal"),
                      });
                      // 加载你刚刚打包好的系统镜像
                      await cx.run("/bin/bash", ["-l"], {
                          env: { TERM: "xterm-256color" },
                          cwd: "/workspace",
                          filesystem: {
                              type: "overlay",
                              layers: [
                                  { type: "tar", url: "rootfs.tar.gz" }
                              ]
                          }
                      });
                  }
                  main();
              </script>
          </body>
          </html>
          EOF

      # 3. 部署
      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
