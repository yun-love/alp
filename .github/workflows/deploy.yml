name: Deploy WebVM
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1. å®‰è£…æ„å»ºå·¥å…· genext2fs (ç”¨äºç”Ÿæˆç£ç›˜é•œåƒ)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y genext2fs

      # 2. æ„å»º Docker å¹¶è½¬æ¢ä¸º EXT2 é•œåƒ (è¿™æ˜¯ WebVM èƒ½è¿è¡Œçš„å…³é”®)
      - name: Build and Convert to Ext2
        run: |
          mkdir -p dist
          mkdir -p rootfs_temp

          # 2.1 æ„å»ºåŸºç¡€é•œåƒ (å»ºè®®ä½¿ç”¨è½»é‡çº§çš„ alpine æˆ– debian-slim)
          docker buildx build --platform linux/386 -t webvm-image --load .
          
          # 2.2 å¯¼å‡º Docker æ–‡ä»¶ç³»ç»Ÿåˆ°ä¸´æ—¶ç›®å½•
          docker create --name temp-container webvm-image
          docker export temp-container | tar -x -C rootfs_temp
          docker rm temp-container
          
          # 2.3 ä¿®å¤ä¸€äº›å¿…è¦çš„ç©ºç›®å½• (CheerpX éœ€è¦)
          mkdir -p rootfs_temp/proc
          mkdir -p rootfs_temp/dev
          mkdir -p rootfs_temp/tmp
          mkdir -p rootfs_temp/home/user

          # 2.4 ä½¿ç”¨ genext2fs ç”Ÿæˆ ext2 ç£ç›˜é•œåƒ (åˆ†é… 512MB ç©ºé—´ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´ -b å‚æ•°)
          # -b: å—æ•°é‡ (524288 = 512MB)
          # -d: æºç›®å½•
          echo "æ­£åœ¨ç”Ÿæˆ ext2 é•œåƒï¼Œè¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´..."
          genext2fs -b 524288 -d rootfs_temp dist/image.ext2
          
          # 2.5 æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf rootfs_temp
          ls -lh dist/image.ext2

      # 3. ä¸‹è½½ COI Service Worker (è§£å†³ SharedArrayBuffer æŠ¥é”™)
      - name: Download Helpers
        run: |
          wget https://raw.githubusercontent.com/gzuidhof/coi-serviceworker/master/coi-serviceworker.js -O dist/coi-serviceworker.js

      # 4. ç”Ÿæˆå‰ç«¯é¡µé¢
      - name: Create Frontend
        run: |
          cat <<EOF > dist/index.html
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>WebVM | Linux in Browser</title>
              
              <!-- 1. å¿…é¡»æœ€å…ˆåŠ è½½ Service Worker è¡¥ä¸ -->
              <script src="coi-serviceworker.js"></script>

              <!-- 2. Xterm ç»ˆç«¯æ ·å¼ -->
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
              
              <style>
                  body { margin: 0; background: #000; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: monospace; }
                  #terminal { flex: 1; width: 100%; }
                  
                  /* å¯åŠ¨é®ç½© */
                  #overlay { 
                      position: absolute; inset: 0; background: #0d1117; z-index: 999; 
                      display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff;
                  }
                  .progress-box { width: 300px; height: 6px; background: #333; border-radius: 3px; margin: 20px 0; overflow: hidden; }
                  .bar { height: 100%; background: #238636; width: 0%; transition: width 0.2s; }
                  #log { color: #8b949e; font-size: 14px; margin-top: 10px; font-family: Consolas, monospace; }
                  .hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
              </style>
          </head>
          <body>
              <div id="overlay">
                  <h2 style="margin:0">ğŸš€ WebVM å¯åŠ¨å™¨</h2>
                  <div class="progress-box"><div class="bar" id="p-bar"></div></div>
                  <div id="log">æ­£åœ¨åˆå§‹åŒ–...</div>
              </div>
              
              <div id="terminal"></div>

              <!-- 3. åŠ è½½ Xterm åº“ -->
              <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
              <script src="https://cdn.jsdelivr.net/npm/xterm-pty@0.9.4/index.js"></script>

              <!-- 4. æ ¸å¿ƒé€»è¾‘ï¼šä½¿ç”¨ module æ–¹å¼å¯¼å…¥ä»¥è§£å†³ "not defined" é—®é¢˜ -->
              <script type="module">
                  // ä½¿ç”¨ WebVM å®˜æ–¹çš„æ„å»ºç‰ˆæœ¬ï¼Œå®ƒé€šå¸¸æ›´ç¨³å®š
                  import CheerpX from 'https://webvm.io/cheerpx.js';

                  const logEl = document.getElementById('log');
                  const barEl = document.getElementById('p-bar');
                  const overlay = document.getElementById('overlay');

                  async function run() {
                      try {
                          // --- ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–ç»ˆç«¯ ---
                          const term = new Terminal({ 
                              theme: { background: '#0d1117' }, 
                              convertEol: true,
                              cursorBlink: true
                          });
                          const fitAddon = { fit: () => { term.resize(Math.floor(window.innerWidth / 9), Math.floor(window.innerHeight / 17)); } };
                          term.open(document.getElementById('terminal'));
                          fitAddon.fit();
                          window.addEventListener('resize', () => fitAddon.fit());
                          
                          term.write('æ¬¢è¿ä½¿ç”¨ WebVM! \r\n');

                          // --- ç¬¬äºŒæ­¥ï¼šä¸‹è½½é•œåƒ (æ˜¾ç¤ºè¿›åº¦æ¡) ---
                          logEl.innerText = "æ­£åœ¨ä¸‹è½½ ext2 ç£ç›˜é•œåƒ (å¯èƒ½è¾ƒå¤§)...";
                          
                          // ä½¿ç”¨ fetch æ‰‹åŠ¨ä¸‹è½½ä»¥è·å–è¿›åº¦
                          const response = await fetch('image.ext2');
                          if (!response.ok) throw new Error("é•œåƒä¸‹è½½å¤±è´¥: " + response.statusText);
                          
                          const contentLength = response.headers.get('content-length');
                          const total = parseInt(contentLength, 10);
                          let loaded = 0;
                          
                          const reader = response.body.getReader();
                          const chunks = [];
                          
                          while(true) {
                              const {done, value} = await reader.read();
                              if (done) break;
                              chunks.push(value);
                              loaded += value.length;
                              if(total) {
                                  const pct = Math.round((loaded / total) * 100);
                                  barEl.style.width = pct + "%";
                                  logEl.innerText = \`ä¸‹è½½ä¸­ \${pct}% (\${(loaded/1024/1024).toFixed(1)} MB)\`;
                              }
                          }
                          
                          logEl.innerText = "æ­£åœ¨å‡†å¤‡æ•°æ®...";
                          const blob = new Blob(chunks);
                          // å°† Blob è½¬æ¢ä¸º ArrayBuffer
                          const imageBuffer = await blob.arrayBuffer();

                          // --- ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ– CheerpX å¼•æ“ ---
                          logEl.innerText = "å¯åŠ¨è™šæ‹Ÿæœºå†…æ ¸...";
                          
                          // åˆ›å»º Linux å®ä¾‹
                          // è¿™é‡Œä½¿ç”¨ WebVM ä¸“ç”¨çš„ IDBDevice æˆ–è€… Overlay å¾ˆéš¾é…ç½®ï¼Œ
                          // æˆ‘ä»¬ä½¿ç”¨æœ€åŸºç¡€çš„ DataDevice æ³¨å…¥ä¸‹è½½çš„ ArrayBuffer
                          const cx = await CheerpX.Linux.create({
                              mounts: [
                                  { type: "cheerpOS", mountPoint: "/proc" },
                                  { type: "cheerpOS", mountPoint: "/dev" },
                                  // å°†æˆ‘ä»¬ä¸‹è½½çš„ Buffer æŒ‚è½½ä¸ºæ ¹ç›®å½• /
                                  { type: "ext2", mountPoint: "/", buffer: imageBuffer }
                              ]
                          });
                          
                          // --- ç¬¬å››æ­¥ï¼šè¿æ¥ç»ˆç«¯å¹¶è¿è¡Œ ---
                          logEl.innerText = "ç³»ç»Ÿå¯åŠ¨ä¸­...";
                          
                          // æ¡¥æ¥ Xterm å’Œ CheerpX
                          cx.setConsole(term.write.bind(term));
                          
                          // å¤„ç†è¾“å…¥ï¼šç®€å•çš„å°†æŒ‰é”®å‘é€ç»™ cx
                          // æ³¨æ„ï¼šåœ¨å¤æ‚çš„äº¤äº’ä¸­å¯èƒ½éœ€è¦ xterm-ptyï¼Œè¿™é‡Œåšæœ€ç®€å¤„ç†
                          term.onData((data) => {
                              // CheerpX ç°åœ¨çš„ API å¯èƒ½ä¼šè‡ªåŠ¨å¤„ç† stdinï¼Œ
                              // å¦‚æœä¸å“åº”é”®ç›˜ï¼Œå¯èƒ½éœ€è¦ cx.stdin.write(data) ä¹‹ç±»çš„æ“ä½œ
                              // ä½†é€šå¸¸ cx.run é…åˆ setConsole ä¼šå¤„ç†å¤§éƒ¨åˆ†è¾“å‡º
                          });

                          overlay.classList.add('hidden');
                          
                          // å¯åŠ¨ Bash
                          // ç¡®ä¿ä½ çš„ Docker é•œåƒé‡Œæœ‰ /bin/bashï¼Œå¦‚æœæ²¡æœ‰(å¦‚alpine)ï¼Œè¯·æ”¹ä¸º /bin/sh
                          await cx.run("/bin/sh", ["-l"], {
                              env: {
                                  HOME: "/root",
                                  TERM: "xterm",
                                  PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
                              }
                          });
                          
                          term.write('\r\n\x1b[31mShell å·²é€€å‡ºã€‚\x1b[m\r\n');

                      } catch (e) {
                          console.error(e);
                          logEl.innerText = "é”™è¯¯: " + e.message;
                          logEl.style.color = "#ff6b6b";
                          
                          if (e.message.includes("defined") || e.message.includes("import")) {
                              alert("æµè§ˆå™¨ä¸å…¼å®¹æˆ–è„šæœ¬åŠ è½½å¤±è´¥ã€‚è¯·å°è¯•ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome/Edgeã€‚");
                          }
                      }
                  }
                  
                  run();
              </script>
          </body>
          </html>
          EOF

      # 5. éƒ¨ç½²
      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4